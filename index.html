<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FPL Team Viewer â€” Next 5 Gameweeks</title>
<meta name="description" content="See your Fantasy Premier League team for the next 5 gameweeks. Enter your FPL ID and share with friends.">
<meta property="og:title" content="FPL Team Viewer">
<meta property="og:description" content="Check your FPL squad for the next 5 gameweeks">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  :root{
    --bg:#0a0e17;--surface:#111827;--surface2:#1a2332;--surface3:#232f42;
    --border:#2a3548;--text:#f1f5f9;--text2:#94a3b8;--text3:#64748b;
    --accent:#38ef7d;--accent2:#11998e;--captain:#fbbf24;--bench:#64748b;
    --danger:#ef4444;
  }
  html{font-family:'DM Sans',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
  body{min-height:100vh;padding:0 16px}

  .container{max-width:1200px;margin:0 auto;padding:32px 0 80px}
  
  /* Header */
  .header{text-align:center;margin-bottom:28px}
  .logo{font-size:13px;font-weight:600;letter-spacing:3px;text-transform:uppercase;color:var(--accent);margin-bottom:8px;font-family:'JetBrains Mono',monospace}
  .title{font-size:28px;font-weight:700;color:var(--text);line-height:1.2}
  .subtitle{font-size:14px;color:var(--text2);margin-top:6px}

  /* Input area */
  .input-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:24px;max-width:560px;margin-left:auto;margin-right:auto}
  .input-row{display:flex;gap:10px}
  .input-row input{
    flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:10px;
    padding:12px 16px;font-size:15px;color:var(--text);font-family:inherit;
    outline:none;transition:border .2s
  }
  .input-row input:focus{border-color:var(--accent)}
  .input-row input::placeholder{color:var(--text3)}
  .input-row button{
    background:linear-gradient(135deg,var(--accent2),var(--accent));
    border:none;border-radius:10px;padding:12px 24px;font-size:14px;
    font-weight:600;color:#0a0e17;cursor:pointer;white-space:nowrap;
    font-family:inherit;transition:opacity .2s
  }
  .input-row button:hover{opacity:.88}
  .input-row button:disabled{opacity:.5;cursor:not-allowed}
  .help-text{font-size:12px;color:var(--text3);margin-top:10px;line-height:1.5}
  .help-text a{color:var(--accent);text-decoration:none}

  /* Manager info */
  .manager-bar{
    display:flex;align-items:center;justify-content:space-between;
    background:var(--surface);border:1px solid var(--border);border-radius:12px;
    padding:14px 18px;margin-bottom:20px;flex-wrap:wrap;gap:8px
  }
  .manager-name{font-size:15px;font-weight:600;color:#fff}
  .manager-name span{color:var(--text2);font-weight:400;font-size:13px;margin-left:6px}
  .manager-meta{font-size:13px;color:var(--text2);display:flex;gap:14px}
  .manager-meta b{color:var(--accent);font-weight:600}
  .share-btn{
    background:var(--surface2);border:1px solid var(--border);border-radius:8px;
    padding:7px 14px;font-size:12px;color:var(--text2);cursor:pointer;
    font-family:inherit;transition:all .2s;display:flex;align-items:center;gap:5px
  }
  .share-btn:hover{border-color:var(--accent);color:var(--accent)}
  .share-btn svg{width:14px;height:14px}

  /* ---- 5-column grid ---- */
  .gw-grid{
    display:grid;grid-template-columns:repeat(5,1fr);gap:10px;
    margin-bottom:20px
  }

  /* Single GW column */
  .gw-col{
    background:var(--surface);border:1px solid var(--border);border-radius:12px;
    overflow:hidden;display:flex;flex-direction:column
  }
  .gw-header{
    text-align:center;padding:10px 6px 8px;
    background:var(--surface2);border-bottom:1px solid var(--border)
  }
  .gw-header .gw-num{font-size:15px;font-weight:700;color:#fff}
  .gw-header .gw-deadline{font-size:10px;color:var(--text3);margin-top:2px}

  .gw-body{padding:10px 4px 12px;flex:1}

  /* Position rows inside a column */
  .pos-section{display:flex;justify-content:center;gap:3px;flex-wrap:wrap;margin-bottom:8px}
  .pos-section:last-child{margin-bottom:0}

  /* Player card â€” compact */
  .player-card{
    width:56px;text-align:center;position:relative;margin-bottom:2px
  }
  .player-badge{
    width:32px;height:32px;border-radius:50%;margin:0 auto 3px;
    display:flex;align-items:center;justify-content:center;
    position:relative;background:var(--surface3);
    box-shadow:0 2px 6px rgba(0,0,0,.3)
  }
  .player-badge img{
    width:28px;height:28px;object-fit:contain;
    image-rendering:auto;border-radius:50%
  }
  /* Fallback colored circle when no logo */
  .player-badge.gk{background:linear-gradient(135deg,#d97706,#f59e0b)}
  .player-badge.def{background:linear-gradient(135deg,#2563eb,#3b82f6)}
  .player-badge.mid{background:linear-gradient(135deg,#16a34a,#22c55e)}
  .player-badge.fwd{background:linear-gradient(135deg,#dc2626,#ef4444)}
  .player-badge .fallback-text{font-size:9px;font-weight:700;color:#fff}

  .captain-badge{
    position:absolute;top:-2px;right:-2px;width:14px;height:14px;
    background:var(--captain);border-radius:50%;font-size:7px;font-weight:700;
    display:flex;align-items:center;justify-content:center;color:#0a0e17;
    box-shadow:0 1px 3px rgba(0,0,0,.4);z-index:2
  }
  .vice-badge{
    position:absolute;top:-2px;right:-2px;width:14px;height:14px;
    background:var(--surface3);border:1.5px solid var(--captain);border-radius:50%;font-size:6px;font-weight:700;
    display:flex;align-items:center;justify-content:center;color:var(--captain);z-index:2
  }

  /* Player name â€” high contrast white */
  .player-name{
    font-size:9px;font-weight:700;color:#ffffff;
    line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis
  }
  /* Fixture text â€” color-coded by difficulty */
  .player-fixture{
    font-size:8px;margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    font-weight:600;letter-spacing:.2px
  }
  .fix-easy{color:#4ade80}   /* FDR 1-2: bright green */
  .fix-mid{color:#fbbf24}    /* FDR 3: amber */
  .fix-hard{color:#f87171}   /* FDR 4-5: red */
  .fix-none{color:var(--text3)}

  /* Bench divider */
  .bench-divider{
    height:1px;background:var(--border);margin:8px 0;position:relative
  }
  .bench-divider::after{
    content:'BENCH';position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    background:var(--surface);padding:0 6px;font-size:7px;letter-spacing:1.5px;color:var(--text3);font-weight:600
  }
  .bench-row{display:flex;justify-content:center;gap:3px;opacity:.55}

  /* States */
  .loading{text-align:center;padding:60px 0}
  .loading .spinner{
    width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);
    border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 12px
  }
  @keyframes spin{to{transform:rotate(360deg)}}
  .loading p{color:var(--text2);font-size:14px}
  .error-msg{
    background:#ef444415;border:1px solid #ef444430;border-radius:10px;
    padding:14px 18px;color:#fca5a5;font-size:13px;text-align:center;margin-top:16px
  }
  .empty-state{text-align:center;padding:60px 20px;color:var(--text3);font-size:14px;line-height:1.6}
  .empty-state .icon{font-size:40px;margin-bottom:12px;opacity:.4}

  /* Ad placeholder */
  .ad-slot{
    background:var(--surface);border:1px dashed var(--border);border-radius:10px;
    padding:16px;text-align:center;margin-top:24px;min-height:60px;
    display:flex;align-items:center;justify-content:center
  }
  .ad-slot span{font-size:11px;color:var(--text3);letter-spacing:1px;text-transform:uppercase}

  /* Toast */
  .toast{
    position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);
    background:var(--surface2);border:1px solid var(--border);border-radius:10px;
    padding:10px 20px;font-size:13px;color:var(--text);z-index:100;
    transition:transform .3s ease;white-space:nowrap
  }
  .toast.show{transform:translateX(-50%) translateY(0)}

  /* Responsive â€” horizontal scroll on small screens */
  @media(max-width:900px){
    .gw-grid{
      grid-template-columns:repeat(5,minmax(160px,1fr));
      overflow-x:auto;-webkit-overflow-scrolling:touch;
      scroll-snap-type:x mandatory;padding-bottom:8px
    }
    .gw-col{scroll-snap-align:start;min-width:160px}
  }
  @media(max-width:480px){
    .container{padding:20px 0 60px}
    .title{font-size:22px}
    .input-row{flex-direction:column}
    .input-row button{padding:14px}
    .player-card{width:50px}
    .player-badge{width:28px;height:28px}
    .player-badge img{width:24px;height:24px}
    .player-name{font-size:8px}
    .player-fixture{font-size:7px}
    .manager-bar{flex-direction:column;align-items:flex-start}
    .gw-grid{grid-template-columns:repeat(5,minmax(140px,1fr))}
    .gw-col{min-width:140px}
  }

  /* Animations */
  @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
  .fade-in{animation:fadeIn .4s ease both}
  .delay-1{animation-delay:.05s}.delay-2{animation-delay:.1s}.delay-3{animation-delay:.15s}
  .delay-4{animation-delay:.2s}.delay-5{animation-delay:.25s}
</style>
</head>
<body>

<div class="container">
  <header class="header">
    <div class="logo">âš½ FPL Viewer</div>
    <h1 class="title">Your Team, Next 5 Gameweeks</h1>
    <p class="subtitle">Enter your FPL ID to see your squad &amp; upcoming fixtures</p>
  </header>

  <div class="input-card">
    <div class="input-row">
      <input type="text" id="fplId" inputmode="numeric" pattern="[0-9]*" placeholder="Enter your FPL ID (e.g. 123456)" aria-label="FPL Team ID">
      <button id="loadBtn" onclick="loadTeam()">View Team</button>
    </div>
    <p class="help-text">
      Find your ID: go to <a href="https://fantasy.premierleague.com" target="_blank" rel="noopener">fantasy.premierleague.com</a> â†’ 
      Pick Team â†’ View Gameweek history. Your ID is in the URL.
    </p>
  </div>

  <div id="content">
    <div class="empty-state">
      <div class="icon">ðŸ‘•</div>
      <p>Enter your FPL ID above to see your team<br>for the upcoming gameweeks.</p>
    </div>
  </div>

  <div class="ad-slot">
    <span>Ad Space</span>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ---- Config ----
const API = 'https://fantasy.premierleague.com';
const PROXIES = [
  url => {
    const path = new URL(url).pathname;
    return `https://fpl-proxy.tuantrung.workers.dev${path}`;
  },
];
let proxyIndex = 0;

// ---- State ----
let bootstrapData = null;
let managerData = null;
let picksData = {};
let nextGWs = [];

// ---- Logo cache (blob URLs, persisted for the session) ----
const logoCache = {};

async function getTeamLogoURL(teamCode) {
  if (logoCache[teamCode]) return logoCache[teamCode];
  const src = `https://resources.premierleague.com/premierleague/badges/t${teamCode}.png`;
  try {
    const res = await fetch(PROXIES[proxyIndex](src), { signal: AbortSignal.timeout(8000) });
    if (!res.ok) throw new Error();
    const blob = await res.blob();
    logoCache[teamCode] = URL.createObjectURL(blob);
  } catch {
    // Direct URL as fallback (may work without CORS for images)
    logoCache[teamCode] = src;
  }
  return logoCache[teamCode];
}

async function prefetchLogos() {
  if (!bootstrapData) return;
  await Promise.allSettled(bootstrapData.teams.map(t => getTeamLogoURL(t.code)));
}

// ---- Fetch with CORS proxy fallback ----
async function apiFetch(url) {
  let lastErr;
  for (let i = 0; i < PROXIES.length; i++) {
    const idx = (proxyIndex + i) % PROXIES.length;
    try {
      const res = await fetch(PROXIES[idx](url), { signal: AbortSignal.timeout(12000) });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      proxyIndex = idx;
      return data;
    } catch(e) { lastErr = e; }
  }
  throw new Error(`All proxies failed. Last: ${lastErr?.message}`);
}

// ---- Init ----
document.addEventListener('DOMContentLoaded', () => {
  const hashId = window.location.hash.replace('#','').trim();
  const savedId = localStorage.getItem('fpl_id');
  const id = hashId || savedId;
  if (id) {
    document.getElementById('fplId').value = id;
    loadTeam();
  }
  document.getElementById('fplId').addEventListener('keydown', e => {
    if (e.key === 'Enter') loadTeam();
  });
});

// ---- Load team ----
async function loadTeam() {
  const input = document.getElementById('fplId');
  const id = input.value.trim();
  if (!id || !/^\d+$/.test(id)) {
    showError('Please enter a valid numeric FPL ID.');
    return;
  }

  localStorage.setItem('fpl_id', id);
  history.replaceState(null, '', `#${id}`);

  const btn = document.getElementById('loadBtn');
  btn.disabled = true;
  btn.textContent = 'Loadingâ€¦';
  showLoading();

  try {
    // 1. Bootstrap data
    if (!bootstrapData) {
      bootstrapData = await apiFetch(`${API}/bootstrap-static/`);
    }

    // 2. Start from NEXT GW (current one has already started)
    const events = bootstrapData.events;
    let startGW = events.find(e => e.is_next);
    if (!startGW) startGW = events.find(e => !e.finished) || events[events.length - 1];
    const startIdx = events.indexOf(startGW);
    nextGWs = events.slice(startIdx, startIdx + 5).filter(Boolean);
    if (nextGWs.length === 0) nextGWs = [startGW];

    // 3. Manager info
    managerData = await apiFetch(`${API}/entry/${id}/`);

    // 4. Picks from latest completed GW
    const latestFinished = events.filter(e => e.finished).pop();
    const currentGW = events.find(e => e.is_current);
    const picksGW = latestFinished || currentGW || events[0];
    picksData = await apiFetch(`${API}/entry/${id}/event/${picksGW.id}/picks/`);

    // 5. Fixtures
    bootstrapData._fixtures = await apiFetch(`${API}/fixtures/`);

    // 6. Render immediately with fallback badges, then swap in logos
    renderAll();
    prefetchLogos().then(() => renderAll());

  } catch(err) {
    showError(`Failed to load team. ${err.message}. Check your FPL ID and try again.`);
    console.error(err);
  } finally {
    btn.disabled = false;
    btn.textContent = 'View Team';
  }
}

// ---- Render all 5 GWs side by side ----
function renderAll() {
  const el = document.getElementById('content');
  el.innerHTML = '';

  // Manager bar
  const m = managerData;
  const bar = document.createElement('div');
  bar.className = 'manager-bar fade-in';
  bar.innerHTML = `
    <div>
      <div class="manager-name">${esc(m.player_first_name)} ${esc(m.player_last_name)}<span>${esc(m.name)}</span></div>
      <div class="manager-meta">
        <span>Overall: <b>${(m.summary_overall_rank||0).toLocaleString()}</b></span>
        <span>Points: <b>${m.summary_overall_points||0}</b></span>
      </div>
    </div>
    <button class="share-btn" onclick="shareLink()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
      Share
    </button>`;
  el.appendChild(bar);

  // 5-column grid
  const grid = document.createElement('div');
  grid.className = 'gw-grid fade-in delay-1';

  const picks = picksData.picks || [];
  const players = bootstrapData.elements;
  const teams = bootstrapData.teams;
  const fixtures = bootstrapData._fixtures || [];

  nextGWs.forEach(gw => {
    const col = document.createElement('div');
    col.className = 'gw-col';

    const dl = gw.deadline_time ? new Date(gw.deadline_time) : null;
    const dlStr = dl ? dl.toLocaleDateString('en-GB',{day:'numeric',month:'short'}) : '';

    // Header
    col.innerHTML = `<div class="gw-header">
      <div class="gw-num">GW${gw.id}</div>
      <div class="gw-deadline">${dlStr}</div>
    </div>`;

    const body = document.createElement('div');
    body.className = 'gw-body';

    const gwFix = fixtures.filter(f => f.event === gw.id);
    const starters = picks.filter(p => p.position <= 11);
    const bench = picks.filter(p => p.position > 11);

    const posMap = {1:'GKP',2:'DEF',3:'MID',4:'FWD'};
    const posOrder = ['GKP','DEF','MID','FWD'];
    const grouped = {};
    posOrder.forEach(p => grouped[p] = []);
    starters.forEach(pick => {
      const pl = players.find(p => p.id === pick.element);
      if (pl) grouped[posMap[pl.element_type]||'MID'].push({pick,player:pl});
    });

    posOrder.forEach(pos => {
      const sec = document.createElement('div');
      sec.className = 'pos-section';
      grouped[pos].forEach(({pick,player}) => {
        sec.innerHTML += renderCard(player, pick, gwFix, teams);
      });
      body.appendChild(sec);
    });

    // Bench
    const div = document.createElement('div');
    div.className = 'bench-divider';
    body.appendChild(div);
    const br = document.createElement('div');
    br.className = 'bench-row';
    bench.forEach(pick => {
      const pl = players.find(p => p.id === pick.element);
      if (pl) br.innerHTML += renderCard(pl, pick, gwFix, teams);
    });
    body.appendChild(br);

    col.appendChild(body);
    grid.appendChild(col);
  });

  el.appendChild(grid);
}

function renderCard(player, pick, gwFix, teams) {
  const teamObj = teams.find(t => t.id === player.team);
  const teamShort = teamObj ? teamObj.short_name : '???';
  const teamCode = teamObj ? teamObj.code : 0;
  const posClass = {1:'gk',2:'def',3:'mid',4:'fwd'}[player.element_type] || 'mid';

  // Logo
  const cached = logoCache[teamCode];
  const inner = cached
    ? `<img src="${cached}" alt="${esc(teamShort)}" loading="lazy">`
    : `<span class="fallback-text">${esc(teamShort)}</span>`;
  const badgeCls = cached ? '' : posClass;

  // Fixture with difficulty color
  let fixHtml = '';
  const pf = gwFix.filter(f => f.team_h === player.team || f.team_a === player.team);
  pf.forEach(f => {
    const home = f.team_h === player.team;
    const opp = teams.find(t => t.id === (home ? f.team_a : f.team_h));
    const name = opp ? opp.short_name : '???';
    const diff = home ? f.team_h_difficulty : f.team_a_difficulty;
    const loc = home ? '(H)' : '(a)';
    const cls = diff <= 2 ? 'fix-easy' : diff >= 4 ? 'fix-hard' : 'fix-mid';
    fixHtml += `<span class="${cls}">${name}${loc}</span> `;
  });
  if (!fixHtml) fixHtml = '<span class="fix-none">â€”</span>';

  let badge = '';
  if (pick.is_captain) badge = '<div class="captain-badge">C</div>';
  else if (pick.is_vice_captain) badge = '<div class="vice-badge">V</div>';

  return `<div class="player-card">
    <div class="player-badge ${badgeCls}">${inner}${badge}</div>
    <div class="player-name" title="${esc(player.web_name)}">${esc(player.web_name)}</div>
    <div class="player-fixture">${fixHtml}</div>
  </div>`;
}

// ---- Helpers ----
function esc(s){return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c])}
function showLoading(){document.getElementById('content').innerHTML=`<div class="loading"><div class="spinner"></div><p>Loading your teamâ€¦</p></div>`}
function showError(msg){document.getElementById('content').innerHTML=`<div class="error-msg">${esc(msg)}</div>`}
function shareLink(){
  const url=window.location.href;
  if(navigator.share) navigator.share({title:'My FPL Team',url});
  else navigator.clipboard.writeText(url).then(()=>showToast('Link copied!')).catch(()=>{});
}
function showToast(msg){
  const t=document.getElementById('toast');t.textContent=msg;
  t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2400);
}
</script>
</body>
</html>
