<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FPL Team Viewer ‚Äî Next 5 Gameweeks</title>
<meta name="description" content="See your Fantasy Premier League team for the next 5 gameweeks. Enter your FPL ID and share with friends.">
<meta property="og:title" content="FPL Team Viewer">
<meta property="og:description" content="Check your FPL squad for the next 5 gameweeks">
<meta property="og:type" content="website">
<meta name="twitter:card" content="summary_large_image">
<!-- OG image is set dynamically via JS when squad loads -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  :root{
    --bg:#0a0e17;--surface:#111827;--surface2:#1a2332;--surface3:#232f42;
    --border:#2a3548;--text:#f1f5f9;--text2:#94a3b8;--text3:#64748b;
    --accent:#38ef7d;--accent2:#11998e;--captain:#fbbf24;--bench:#64748b;
    --danger:#ef4444;
  }
  html{font-family:'DM Sans',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}
  body{min-height:100vh;padding:0 16px}

  .container{max-width:1200px;margin:0 auto;padding:32px 0 80px}
  
  /* Header */
  .header{text-align:center;margin-bottom:28px}
  .logo{font-size:13px;font-weight:600;letter-spacing:3px;text-transform:uppercase;color:var(--accent);margin-bottom:8px;font-family:'JetBrains Mono',monospace}
  .title{font-size:28px;font-weight:700;color:var(--text);line-height:1.2}
  .subtitle{font-size:14px;color:var(--text2);margin-top:6px}

  /* Input area */
  .input-card{background:var(--surface);border:1px solid var(--border);border-radius:14px;padding:20px;margin-bottom:24px;max-width:560px;margin-left:auto;margin-right:auto}
  .input-row{display:flex;gap:10px}
  .input-row input{
    flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:10px;
    padding:12px 16px;font-size:15px;color:var(--text);font-family:inherit;
    outline:none;transition:border .2s
  }
  .input-row input:focus{border-color:var(--accent)}
  .input-row input::placeholder{color:var(--text3)}
  .input-row button{
    background:linear-gradient(135deg,var(--accent2),var(--accent));
    border:none;border-radius:10px;padding:12px 24px;font-size:14px;
    font-weight:600;color:#0a0e17;cursor:pointer;white-space:nowrap;
    font-family:inherit;transition:opacity .2s
  }
  .input-row button:hover{opacity:.88}
  .input-row button:disabled{opacity:.5;cursor:not-allowed}
  .help-text{font-size:12px;color:var(--text3);margin-top:10px;line-height:1.5}
  .help-text a{color:var(--accent);text-decoration:none}

  /* Manager info */
  .manager-bar{
    display:flex;align-items:center;justify-content:space-between;
    background:var(--surface);border:1px solid var(--border);border-radius:12px;
    padding:14px 18px;margin-bottom:6px;flex-wrap:wrap;gap:8px
  }
  .manager-name{font-size:15px;font-weight:600;color:#fff}
  .manager-name span{color:var(--text2);font-weight:400;font-size:13px;margin-left:6px}
  .manager-meta{font-size:13px;color:var(--text2);display:flex;gap:14px;flex-wrap:wrap}
  .manager-meta b{color:var(--accent);font-weight:600}
  .btn-group{display:flex;gap:6px}
  .share-btn,.img-btn{
    background:var(--surface2);border:1px solid var(--border);border-radius:8px;
    padding:7px 14px;font-size:12px;color:var(--text2);cursor:pointer;
    font-family:inherit;transition:all .2s;display:flex;align-items:center;gap:5px
  }
  .share-btn:hover,.img-btn:hover{border-color:var(--accent);color:var(--accent)}
  .share-btn svg,.img-btn svg{width:14px;height:14px}

  /* Squad stats bar */
  .stats-bar{
    display:flex;gap:8px;margin-bottom:16px;overflow-x:auto;padding:2px 0
  }
  .stat-chip{
    background:var(--surface);border:1px solid var(--border);border-radius:8px;
    padding:6px 12px;font-size:11px;color:var(--text2);white-space:nowrap;
    display:flex;align-items:center;gap:5px
  }
  .stat-chip b{color:var(--text);font-weight:600;font-size:12px}
  .stat-chip .warn{color:#f87171}
  .stat-chip .ok{color:#4ade80}

  /* ---- Carousel layout ---- */
  .gw-carousel-wrapper{position:relative;margin-bottom:20px}
  .gw-carousel{
    overflow:hidden;border-radius:12px;
    position:relative;touch-action:pan-y;cursor:grab
  }
  .gw-carousel.dragging{cursor:grabbing;user-select:none}
  .gw-carousel.dragging .gw-track{transition:none}
  .gw-track{
    display:flex;gap:8px;transition:transform .35s cubic-bezier(.4,0,.2,1);
    will-change:transform
  }
  .gw-slide{
    min-width:calc((100% - 16px) / 3);box-sizing:border-box;
    background:var(--surface);border:1px solid var(--border);border-radius:12px;
    display:flex;flex-direction:column;flex-shrink:0
  }
  .gw-header{
    text-align:center;padding:12px 8px 10px;
    background:var(--surface2);border-bottom:1px solid var(--border)
  }
  .gw-header .gw-num{font-size:18px;font-weight:700;color:#fff}
  .gw-header .gw-deadline{font-size:11px;color:var(--text3);margin-top:2px}
  .gw-body{padding:16px 8px 18px;flex:1}

  .pos-section{display:flex;justify-content:center;gap:8px;flex-wrap:nowrap;margin-bottom:12px}
  .pos-section:last-child{margin-bottom:0}

  /* Carousel navigation arrows */
  .carousel-arrow{
    position:absolute;top:50%;transform:translateY(-50%);
    width:36px;height:36px;border-radius:50%;
    background:var(--surface2);border:1px solid var(--border);
    color:var(--text);font-size:18px;cursor:pointer;
    display:flex;align-items:center;justify-content:center;
    z-index:5;transition:all .2s;opacity:.85
  }
  .carousel-arrow:hover{background:var(--surface3);border-color:var(--accent);color:var(--accent);opacity:1}
  .carousel-arrow.prev{left:-18px}
  .carousel-arrow.next{right:-18px}
  .carousel-arrow:disabled{opacity:.3;cursor:default;border-color:var(--border);color:var(--text3)}

  /* Carousel dots */
  .carousel-dots{
    display:flex;justify-content:center;gap:8px;margin-top:12px
  }
  .carousel-dot{
    width:8px;height:8px;border-radius:50%;
    background:var(--border);cursor:pointer;
    transition:all .2s;border:none;padding:0
  }
  .carousel-dot.active{background:var(--accent);transform:scale(1.25)}
  .carousel-dot:hover{background:var(--text3)}

  /* GW label strip */
  .gw-strip{
    display:flex;justify-content:center;gap:4px;margin-bottom:10px
  }
  .gw-strip-btn{
    padding:6px 14px;border-radius:8px;font-size:12px;font-weight:600;
    background:var(--surface);border:1px solid var(--border);color:var(--text2);
    cursor:pointer;transition:all .2s;font-family:inherit
  }
  .gw-strip-btn.active{background:var(--accent);color:#0a0e17;border-color:var(--accent)}
  .gw-strip-btn:hover:not(.active){border-color:var(--text3);color:var(--text)}

  /* Player card */
  .player-card{
    width:64px;text-align:center;position:relative;margin-bottom:2px
  }
  .player-badge{
    width:38px;height:38px;border-radius:50%;margin:0 auto 3px;
    display:flex;align-items:center;justify-content:center;
    position:relative;background:var(--surface3);
    box-shadow:0 2px 6px rgba(0,0,0,.3)
  }
  .player-badge img{width:32px;height:32px;object-fit:contain;border-radius:50%}
  .player-badge.gk{background:linear-gradient(135deg,#d97706,#f59e0b)}
  .player-badge.def{background:linear-gradient(135deg,#2563eb,#3b82f6)}
  .player-badge.mid{background:linear-gradient(135deg,#16a34a,#22c55e)}
  .player-badge.fwd{background:linear-gradient(135deg,#dc2626,#ef4444)}
  .player-badge .fallback-text{font-size:9px;font-weight:700;color:#fff}

  .captain-badge{
    position:absolute;top:0;right:6px;width:15px;height:15px;
    background:var(--captain);border-radius:50%;font-size:8px;font-weight:700;
    display:flex;align-items:center;justify-content:center;color:#0a0e17;
    box-shadow:0 1px 3px rgba(0,0,0,.5);z-index:3
  }
  .vice-badge{
    position:absolute;top:0;right:6px;width:15px;height:15px;
    background:var(--surface3);border:1.5px solid var(--captain);border-radius:50%;font-size:7px;font-weight:700;
    display:flex;align-items:center;justify-content:center;color:var(--captain);z-index:3
  }
  /* Injury/doubt flag */
  .status-dot{
    position:absolute;bottom:-1px;left:-1px;width:10px;height:10px;
    border-radius:50%;border:1.5px solid var(--surface);z-index:2;font-size:0
  }
  .status-dot.injured{background:#ef4444}
  .status-dot.doubt{background:#f59e0b}
  .status-dot.suspended{background:#ef4444}

  .player-name{font-size:10px;font-weight:700;color:#ffffff;line-height:1.2;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;text-shadow:0 1px 3px rgba(0,0,0,.8),0 0 6px rgba(0,0,0,.5)}
  .player-fixture{font-size:8px;margin-top:1px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:600;letter-spacing:.2px}
  .fix-easy{color:#4ade80}
  .fix-mid{color:#fbbf24}
  .fix-hard{color:#f87171}
  .fix-none{color:var(--text3)}
  /* Bench */
  .bench-divider{height:1px;background:var(--border);margin:8px 0;position:relative}
  .bench-divider::after{
    content:'BENCH';position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);
    background:var(--surface);padding:0 6px;font-size:7px;letter-spacing:1.5px;color:var(--text3);font-weight:600
  }
  .bench-row{display:flex;justify-content:center;gap:8px;opacity:.55}

  /* States */
  .loading{text-align:center;padding:60px 0}
  .loading .spinner{width:32px;height:32px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin:0 auto 12px}
  @keyframes spin{to{transform:rotate(360deg)}}
  .loading p{color:var(--text2);font-size:14px}
  .error-msg{background:#ef444415;border:1px solid #ef444430;border-radius:10px;padding:14px 18px;color:#fca5a5;font-size:13px;text-align:center;margin-top:16px}
  .empty-state{text-align:center;padding:60px 20px;color:var(--text3);font-size:14px;line-height:1.6}
  .empty-state .icon{font-size:40px;margin-bottom:12px;opacity:.4}

  .ad-slot{background:var(--surface);border:1px dashed var(--border);border-radius:10px;padding:16px;text-align:center;margin-top:24px;min-height:60px;display:flex;align-items:center;justify-content:center}
  .ad-slot span{font-size:11px;color:var(--text3);letter-spacing:1px;text-transform:uppercase}

  .toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%) translateY(80px);background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:10px 20px;font-size:13px;color:var(--text);z-index:100;transition:transform .3s ease;white-space:nowrap}
  .toast.show{transform:translateX(-50%) translateY(0)}

  /* Tooltip for injury news */
  .player-card[data-news]:hover::after{
    content:attr(data-news);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);
    background:#1e293b;border:1px solid var(--border);border-radius:6px;padding:4px 8px;
    font-size:9px;color:#fca5a5;white-space:nowrap;z-index:10;pointer-events:none;
    max-width:160px;overflow:hidden;text-overflow:ellipsis
  }

  @media(max-width:900px){
    .gw-slide{min-width:calc(100% - 12px)}
    .gw-track{gap:12px}
    .carousel-arrow.prev{left:-4px}
    .carousel-arrow.next{right:-4px}
    .carousel-arrow{width:32px;height:32px;font-size:16px}
  }
  @media(max-width:480px){
    .container{padding:20px 0 60px}
    .title{font-size:22px}
    .input-row{flex-direction:column}
    .input-row button{padding:14px}
    .player-card{width:56px}
    .player-badge{width:34px;height:34px}
    .player-badge img{width:28px;height:28px}
    .player-name{font-size:9px}
    .player-fixture{font-size:8px}
    .manager-bar{flex-direction:column;align-items:flex-start}
    .stats-bar{gap:6px}
    .carousel-arrow{width:28px;height:28px;font-size:14px}
    .carousel-arrow.prev{left:-2px}
    .carousel-arrow.next{right:-2px}
    .pos-section{gap:4px}
    .bench-row{gap:4px}
  }

  /* Form dot on player card */
  .form-dot{
    position:absolute;top:-1px;left:-1px;width:10px;height:10px;
    border-radius:50%;border:1.5px solid var(--surface);z-index:2
  }
  .form-dot.hot{background:#4ade80}
  .form-dot.warm{background:#fbbf24}
  .form-dot.cold{background:#f87171}

  /* Ownership badge */
  .own-badge{
    font-size:7px;font-weight:700;letter-spacing:.3px;
    padding:1px 3px;border-radius:3px;display:inline-block;
    line-height:1.3;margin-top:1px
  }
  .own-badge.diff{background:#8b5cf620;color:#a78bfa;border:1px solid #8b5cf640}
  .own-badge.ess{background:#38ef7d15;color:#4ade80;border:1px solid #38ef7d30}

  /* Form vs PPG indicator */
  .form-indicator{
    font-size:7px;font-weight:700;display:flex;align-items:center;
    justify-content:center;gap:1px;margin-top:1px;line-height:1
  }
  .form-indicator.rising{color:#4ade80}
  .form-indicator.falling{color:#f87171}
  .form-indicator.steady{color:#94a3b8}

  /* Legend */
  .legend-bar{
    display:flex;flex-wrap:wrap;gap:10px;align-items:center;
    padding:8px 14px;margin-bottom:12px;border-radius:8px;
    background:var(--surface);border:1px solid var(--border)
  }
  .legend-bar .legend-title{font-size:10px;font-weight:700;color:var(--text3);letter-spacing:1px;text-transform:uppercase;margin-right:4px}
  .legend-item{display:flex;align-items:center;gap:4px;font-size:10px;color:var(--text2)}
  .legend-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
  .legend-swatch{padding:1px 4px;border-radius:3px;font-size:8px;font-weight:700;line-height:1.3}

  /* EP chip accent */
  .stat-chip .ep{color:#a78bfa;font-weight:600}

  @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
  .fade-in{animation:fadeIn .4s ease both}
  .delay-1{animation-delay:.05s}.delay-2{animation-delay:.1s}
</style>
</head>
<body>

<div class="container">
  <header class="header">
    <div class="logo">‚öΩ FPL Viewer</div>
    <h1 class="title">Your Team, Next 5 Gameweeks</h1>
    <p class="subtitle">Enter your FPL ID to see your squad &amp; upcoming fixtures</p>
  </header>

  <div class="input-card">
    <div class="input-row">
      <input type="text" id="fplId" inputmode="numeric" pattern="[0-9]*" placeholder="Enter your FPL ID (e.g. 123456)" aria-label="FPL Team ID">
      <button id="loadBtn" onclick="loadTeam()">View Team</button>
    </div>
    <p class="help-text">
      Find your ID: go to <a href="https://fantasy.premierleague.com" target="_blank" rel="noopener">fantasy.premierleague.com</a> ‚Üí 
      Pick Team ‚Üí View Gameweek history. Your ID is in the URL.
    </p>
  </div>

  <div id="content">
    <div class="empty-state">
      <div class="icon">üëï</div>
      <p>Enter your FPL ID above to see your team<br>for the upcoming gameweeks.</p>
    </div>
  </div>

  <div class="ad-slot">
    <span>Ad Space</span>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ---- Config ----
const API = 'https://fantasy.premierleague.com';
const PROXIES = [
  url => {
    const path = new URL(url).pathname;
    return `https://fpl-proxy.tuantrung.workers.dev${path}`;
  },
];
let proxyIndex = 0;

// ---- State ----
let bootstrapData = null;
let managerData = null;
let picksData = {};
let nextGWs = [];
let historyData = null;

// ---- Logo URLs ‚Äî self-hosted on R2 for CORS support ----
const BADGE_CDN = 'https://pub-9618cf27a5ef43f6acbd0099b778414b.r2.dev';
const logoCache = {};
function getTeamLogoURL(teamCode) {
  if (!logoCache[teamCode]) {
    logoCache[teamCode] = `${BADGE_CDN}/badges/t${teamCode}.png`;
  }
  return logoCache[teamCode];
}
function prefetchLogos() {
  // Direct URLs don't need prefetching, but populate the cache
  // so renderCard finds entries immediately
  if (!bootstrapData) return;
  bootstrapData.teams.forEach(t => getTeamLogoURL(t.code));
}

// ---- Fetch ----
async function apiFetch(url) {
  let lastErr;
  for (let i = 0; i < PROXIES.length; i++) {
    const idx = (proxyIndex + i) % PROXIES.length;
    try {
      const res = await fetch(PROXIES[idx](url), { signal: AbortSignal.timeout(12000) });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      proxyIndex = idx;
      return data;
    } catch(e) { lastErr = e; }
  }
  throw new Error(`All proxies failed. Last: ${lastErr?.message}`);
}

// ---- URL helpers: use ?id= query param (survives social sharing) ----
function getIdFromURL() {
  const params = new URLSearchParams(window.location.search);
  const qid = params.get('id');
  if (qid) return qid.trim();
  // Backward compat: also check hash
  const hid = window.location.hash.replace('#','').trim();
  return hid || '';
}
function setIdInURL(id) {
  const url = new URL(window.location);
  url.searchParams.set('id', id);
  url.hash = ''; // remove old hash
  history.replaceState(null, '', url);
}

// ---- Init ----
document.addEventListener('DOMContentLoaded', () => {
  const urlId = getIdFromURL();
  const savedId = localStorage.getItem('fpl_id');
  const id = urlId || savedId;
  if (id) {
    document.getElementById('fplId').value = id;
    loadTeam();
  }
  document.getElementById('fplId').addEventListener('keydown', e => {
    if (e.key === 'Enter') loadTeam();
  });
});

// ---- Load team ----
async function loadTeam() {
  const input = document.getElementById('fplId');
  const id = input.value.trim();
  if (!id || !/^\d+$/.test(id)) {
    showError('Please enter a valid numeric FPL ID.');
    return;
  }

  localStorage.setItem('fpl_id', id);
  setIdInURL(id);

  const btn = document.getElementById('loadBtn');
  btn.disabled = true;
  btn.textContent = 'Loading‚Ä¶';
  showLoading();

  try {
    // 1. Bootstrap
    if (!bootstrapData) {
      bootstrapData = await apiFetch(`${API}/bootstrap-static/`);
    }

    // 2. Next GWs
    const events = bootstrapData.events;
    let startGW = events.find(e => e.is_next);
    if (!startGW) startGW = events.find(e => !e.finished) || events[events.length - 1];
    const startIdx = events.indexOf(startGW);
    nextGWs = events.slice(startIdx, startIdx + 5).filter(Boolean);
    if (nextGWs.length === 0) nextGWs = [startGW];

    // 3. Manager info
    managerData = await apiFetch(`${API}/entry/${id}/`);

    // 4. Manager history (for chips used, GW history)
    historyData = await apiFetch(`${API}/entry/${id}/history/`);

    // 5. Picks ‚Äî prefer current GW (has active captain/team selection)
    const currentGW = events.find(e => e.is_current);
    const latestFinished = events.filter(e => e.finished).pop();
    const picksGW = currentGW || latestFinished || events[0];
    picksData = await apiFetch(`${API}/entry/${id}/event/${picksGW.id}/picks/`);

    // 6. Fixtures
    bootstrapData._fixtures = await apiFetch(`${API}/fixtures/`);

    // 7. Update OG tags dynamically (helps some crawlers)
    updateOGTags();

    // 8. Populate logo cache and render
    prefetchLogos();
    renderAll();

  } catch(err) {
    showError(`Failed to load team. ${err.message}. Check your FPL ID and try again.`);
    console.error(err);
  } finally {
    btn.disabled = false;
    btn.textContent = 'View Team';
  }
}

// ---- Update OG meta tags ----
function updateOGTags() {
  if (!managerData) return;
  const name = `${managerData.player_first_name} ${managerData.player_last_name}`;
  const pts = managerData.summary_overall_points || 0;
  const rank = (managerData.summary_overall_rank || 0).toLocaleString();
  setMeta('og:title', `${name}'s FPL Team`);
  setMeta('og:description', `${managerData.name} ‚Ä¢ ${pts} pts ‚Ä¢ Rank ${rank} ‚Äî Next 5 GW fixtures`);
  document.title = `${name} ‚Äî FPL Team Viewer`;
}
function setMeta(prop, content) {
  let el = document.querySelector(`meta[property="${prop}"]`);
  if (!el) { el = document.createElement('meta'); el.setAttribute('property', prop); document.head.appendChild(el); }
  el.setAttribute('content', content);
}

// ---- Compute squad stats ----
function getSquadStats() {
  const picks = picksData.picks || [];
  const players = bootstrapData.elements;
  let totalValue = 0, totalPts = 0, injuredCount = 0, doubtCount = 0;
  let startersEP = 0;
  const squadPlayers = [];

  picks.forEach(pick => {
    const pl = players.find(p => p.id === pick.element);
    if (!pl) return;
    squadPlayers.push(pl);
    totalValue += pl.now_cost;
    totalPts += pl.total_points;
    if (pl.status === 'i' || pl.status === 's') injuredCount++;
    else if (pl.status === 'd') doubtCount++;
    // Sum EP for starters only (position 1-11), apply captain multiplier
    if (pick.position <= 11) {
      const ep = parseFloat(pl.ep_next) || 0;
      startersEP += pick.is_captain ? ep * 2 : ep;
    }
  });

  // Chips: each manager starts with 2 WC, 2 FH, 2 BB, 2 TC ‚Äî deduct used
  const allChips = ['wildcard','wildcard','freehit','freehit','bboost','bboost','3xc','3xc'];
  const usedChips = (historyData?.chips || []).map(c => c.name);
  const remaining = [...allChips];
  usedChips.forEach(used => {
    const idx = remaining.indexOf(used);
    if (idx !== -1) remaining.splice(idx, 1);
  });

  // Bank
  const lastGW = historyData?.current?.slice(-1)[0];
  const bank = lastGW ? lastGW.bank : 0;

  return { totalValue, totalPts, injuredCount, doubtCount, bank, chipsRemaining: remaining, squadPlayers, startersEP };
}

// ---- Render ----
function renderAll() {
  const el = document.getElementById('content');
  el.innerHTML = '';

  const m = managerData;
  const stats = getSquadStats();

  // Manager bar
  const bar = document.createElement('div');
  bar.className = 'manager-bar fade-in';
  bar.innerHTML = `
    <div>
      <div class="manager-name">${esc(m.player_first_name)} ${esc(m.player_last_name)}<span>${esc(m.name)}</span></div>
      <div class="manager-meta">
        <span>Rank: <b>${(m.summary_overall_rank||0).toLocaleString()}</b></span>
        <span>Points: <b>${m.summary_overall_points||0}</b></span>
      </div>
    </div>
    <div class="btn-group">
      <button class="img-btn" onclick="generateShareImage()" title="Download shareable image">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><path d="M21 15l-5-5L5 21"/></svg>
        Image
      </button>
      <button class="share-btn" onclick="shareLink()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg>
        Share
      </button>
    </div>`;
  el.appendChild(bar);

  // Stats bar
  const sb = document.createElement('div');
  sb.className = 'stats-bar fade-in';
  const tv = (stats.totalValue / 10).toFixed(1);
  const bk = (stats.bank / 10).toFixed(1);
  // Chips remaining display
  const chipNames = {wildcard:'WC',freehit:'FH',bboost:'BB','3xc':'TC'};
  const chipCounts = {};
  stats.chipsRemaining.forEach(c => { chipCounts[c] = (chipCounts[c]||0) + 1; });
  const chipLabels = Object.entries(chipCounts).map(([k,v]) => `${chipNames[k]||k}√ó${v}`);
  const chips = chipLabels.length
    ? `<div class="stat-chip">Chips left: <b>${chipLabels.join(', ')}</b></div>`
    : `<div class="stat-chip">Chips left: <b>None</b></div>`;
  let flagsHtml = '';
  if (stats.injuredCount) flagsHtml += `<div class="stat-chip"><span class="warn">‚óè</span> ${stats.injuredCount} injured/suspended</div>`;
  if (stats.doubtCount) flagsHtml += `<div class="stat-chip"><span style="color:#f59e0b">‚óè</span> ${stats.doubtCount} doubtful</div>`;
  const epDisplay = stats.startersEP.toFixed(1);
  sb.innerHTML = `
    <div class="stat-chip">Squad Value: <b>¬£${tv}m</b></div>
    <div class="stat-chip">Bank: <b>¬£${bk}m</b></div>
    <div class="stat-chip">Squad Pts: <b>${stats.totalPts}</b></div>
    <div class="stat-chip">Expected Pts: <b class="ep">${epDisplay}</b></div>
    ${flagsHtml}${chips}
  `;
  el.appendChild(sb);

  // Legend
  const legend = document.createElement('div');
  legend.className = 'legend-bar fade-in';
  legend.innerHTML = `
    <span class="legend-title">Legend</span>
    <div class="legend-item"><div class="legend-dot" style="background:#4ade80"></div> Hot form (6+)</div>
    <div class="legend-item"><div class="legend-dot" style="background:#fbbf24"></div> OK form (3-6)</div>
    <div class="legend-item"><div class="legend-dot" style="background:#f87171"></div> Cold form (&lt;3)</div>
    <div class="legend-item"><span class="legend-swatch" style="background:#8b5cf620;color:#a78bfa;border:1px solid #8b5cf640">DIFF</span> &lt;10% owned</div>
    <div class="legend-item"><span class="legend-swatch" style="background:#38ef7d15;color:#4ade80;border:1px solid #38ef7d30">ESS</span> &gt;50% owned</div>
    <div class="legend-item"><span style="color:#4ade80;font-weight:700">‚ñ≤</span> In-form</div>
    <div class="legend-item"><span style="color:#f87171;font-weight:700">‚ñº</span> Off-form</div>
  `;
  el.appendChild(legend);

  // Carousel
  const picks = picksData.picks || [];
  const players = bootstrapData.elements;
  const teams = bootstrapData.teams;
  const fixtures = bootstrapData._fixtures || [];

  // GW strip (tab buttons)
  const strip = document.createElement('div');
  strip.className = 'gw-strip fade-in delay-1';
  nextGWs.forEach((gw, i) => {
    const btn = document.createElement('button');
    btn.className = 'gw-strip-btn' + (i === 0 ? ' active' : '');
    btn.textContent = `GW${gw.id}`;
    btn.onclick = () => {
      const perView = getSlidesPerView();
      // Scroll so clicked GW is visible; prefer making it the leftmost unless near the end
      const target = Math.min(i, getMaxSlide());
      goToSlide(target);
    };
    strip.appendChild(btn);
  });
  el.appendChild(strip);

  const wrapper = document.createElement('div');
  wrapper.className = 'gw-carousel-wrapper fade-in delay-1';

  const carousel = document.createElement('div');
  carousel.className = 'gw-carousel';
  const track = document.createElement('div');
  track.className = 'gw-track';
  track.id = 'gwTrack';

  nextGWs.forEach(gw => {
    const slide = document.createElement('div');
    slide.className = 'gw-slide';
    const dl = gw.deadline_time ? new Date(gw.deadline_time) : null;
    const dlStr = dl ? dl.toLocaleDateString('en-GB',{day:'numeric',month:'short'}) : '';
    slide.innerHTML = `<div class="gw-header"><div class="gw-num">GW${gw.id}</div><div class="gw-deadline">${dlStr}</div></div>`;

    const body = document.createElement('div');
    body.className = 'gw-body';
    const gwFix = fixtures.filter(f => f.event === gw.id);
    const starters = picks.filter(p => p.position <= 11);
    const bench = picks.filter(p => p.position > 11);

    const posMap = {1:'GKP',2:'DEF',3:'MID',4:'FWD'};
    const posOrder = ['GKP','DEF','MID','FWD'];
    const grouped = {};
    posOrder.forEach(p => grouped[p] = []);
    starters.forEach(pick => {
      const pl = players.find(p => p.id === pick.element);
      if (pl) grouped[posMap[pl.element_type]||'MID'].push({pick,player:pl});
    });

    posOrder.forEach(pos => {
      const sec = document.createElement('div');
      sec.className = 'pos-section';
      grouped[pos].forEach(({pick,player}) => { sec.innerHTML += renderCard(player, pick, gwFix, teams); });
      body.appendChild(sec);
    });

    const divEl = document.createElement('div');
    divEl.className = 'bench-divider';
    body.appendChild(divEl);
    const benchRow = document.createElement('div');
    benchRow.className = 'bench-row';
    bench.forEach(pick => {
      const pl = players.find(p => p.id === pick.element);
      if (pl) benchRow.innerHTML += renderCard(pl, pick, gwFix, teams);
    });
    body.appendChild(benchRow);
    slide.appendChild(body);
    track.appendChild(slide);
  });

  carousel.appendChild(track);

  // Arrow buttons
  const prevBtn = document.createElement('button');
  prevBtn.className = 'carousel-arrow prev';
  prevBtn.innerHTML = '&#8249;';
  prevBtn.onclick = () => goToSlide(currentSlide - 1);

  const nextBtn = document.createElement('button');
  nextBtn.className = 'carousel-arrow next';
  nextBtn.innerHTML = '&#8250;';
  nextBtn.onclick = () => goToSlide(currentSlide + 1);

  wrapper.appendChild(prevBtn);
  wrapper.appendChild(carousel);
  wrapper.appendChild(nextBtn);

  // Dots
  const dots = document.createElement('div');
  dots.className = 'carousel-dots';
  dots.id = 'carouselDots';
  nextGWs.forEach((_, i) => {
    const dot = document.createElement('button');
    dot.className = 'carousel-dot' + (i === 0 ? ' active' : '');
    dot.onclick = () => goToSlide(i);
    dots.appendChild(dot);
  });
  wrapper.appendChild(dots);

  el.appendChild(wrapper);

  // Carousel state
  currentSlide = 0;
  totalSlides = nextGWs.length;
  updateCarouselUI();
  initSwipe(carousel);

  // Auto-scroll to manager bar on mobile so content is immediately visible
  if (window.innerWidth <= 900) {
    requestAnimationFrame(() => {
      bar.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });
  }
}

// ---- Carousel logic ----
let currentSlide = 0;
let totalSlides = 0;

function getSlidesPerView() {
  return window.innerWidth > 900 ? 3 : 1;
}

function getMaxSlide() {
  return Math.max(0, totalSlides - getSlidesPerView());
}

function goToSlide(idx) {
  const max = getMaxSlide();
  if (idx < 0 || idx > max) return;
  currentSlide = idx;
  updateCarouselUI();
}

function getTrackGap() {
  const track = document.getElementById('gwTrack');
  if (!track) return 0;
  return parseFloat(getComputedStyle(track).gap) || 0;
}

function updateCarouselUI() {
  const track = document.getElementById('gwTrack');
  if (!track) return;
  const slide = track.querySelector('.gw-slide');
  if (!slide) return;

  const gap = getTrackGap();
  const perView = getSlidesPerView();
  const offset = currentSlide * (slide.offsetWidth + gap);
  track.style.transform = `translateX(-${offset}px)`;

  // Update dots ‚Äî highlight range of visible slides
  const dots = document.querySelectorAll('.carousel-dot');
  dots.forEach((d, i) => d.classList.toggle('active', i >= currentSlide && i < currentSlide + perView));

  // Update strip buttons ‚Äî highlight range of visible slides
  const stripBtns = document.querySelectorAll('.gw-strip-btn');
  stripBtns.forEach((b, i) => b.classList.toggle('active', i >= currentSlide && i < currentSlide + perView));

  // Update arrows
  const prev = document.querySelector('.carousel-arrow.prev');
  const next = document.querySelector('.carousel-arrow.next');
  if (prev) prev.disabled = currentSlide === 0;
  if (next) next.disabled = currentSlide >= getMaxSlide();
}

function getBaseOffset() {
  const track = document.getElementById('gwTrack');
  if (!track) return 0;
  const slide = track.querySelector('.gw-slide');
  if (!slide) return 0;
  return currentSlide * (slide.offsetWidth + getTrackGap());
}

function getMaxOffset() {
  const track = document.getElementById('gwTrack');
  if (!track) return 0;
  const slide = track.querySelector('.gw-slide');
  if (!slide) return 0;
  return getMaxSlide() * (slide.offsetWidth + getTrackGap());
}

function clampDragOffset(rawOffset) {
  // rawOffset is the proposed translateX value (negative = scrolled right)
  if (rawOffset > 0) return rawOffset * 0.3;               // rubber-band left edge
  const max = -getMaxOffset();
  if (rawOffset < max) return max + (rawOffset - max) * 0.3; // rubber-band right edge
  return rawOffset;
}

function setTrackOffset(px) {
  const track = document.getElementById('gwTrack');
  if (track) track.style.transform = `translateX(${px}px)`;
}

function initSwipe(el) {
  let startX = 0, startY = 0, diffX = 0, swiping = false;

  // Touch events (mobile)
  el.addEventListener('touchstart', e => {
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
    swiping = true;
    el.classList.add('dragging');
  }, {passive: true});
  el.addEventListener('touchmove', e => {
    if (!swiping) return;
    diffX = e.touches[0].clientX - startX;
    const diffY = e.touches[0].clientY - startY;
    if (Math.abs(diffY) > Math.abs(diffX)) { swiping = false; el.classList.remove('dragging'); return; }
    setTrackOffset(clampDragOffset(-getBaseOffset() + diffX));
  }, {passive: true});
  el.addEventListener('touchend', () => {
    if (!swiping) { el.classList.remove('dragging'); return; }
    el.classList.remove('dragging');
    void el.offsetWidth; // force reflow so transition re-enables
    if (diffX > 40) goToSlide(currentSlide - 1);
    else if (diffX < -40) goToSlide(currentSlide + 1);
    else updateCarouselUI();
    swiping = false; diffX = 0;
  }, {passive: true});

  // Mouse drag events (desktop)
  let dragging = false;
  el.addEventListener('mousedown', e => {
    startX = e.clientX;
    diffX = 0;
    dragging = true;
    el.classList.add('dragging');
    e.preventDefault();
  });
  document.addEventListener('mousemove', e => {
    if (!dragging) return;
    diffX = e.clientX - startX;
    setTrackOffset(clampDragOffset(-getBaseOffset() + diffX));
  });
  document.addEventListener('mouseup', () => {
    if (!dragging) return;
    el.classList.remove('dragging');
    dragging = false;
    void el.offsetWidth; // force reflow so transition re-enables
    if (diffX > 50) goToSlide(currentSlide - 1);
    else if (diffX < -50) goToSlide(currentSlide + 1);
    else updateCarouselUI();
    diffX = 0;
  });

  // Keyboard navigation
  document.addEventListener('keydown', e => {
    if (e.key === 'ArrowLeft') goToSlide(currentSlide - 1);
    else if (e.key === 'ArrowRight') goToSlide(currentSlide + 1);
  });

  // Re-clamp on resize (e.g. crossing the 900px breakpoint)
  window.addEventListener('resize', () => {
    const max = getMaxSlide();
    if (currentSlide > max) currentSlide = max;
    updateCarouselUI();
  });
}

function renderCard(player, pick, gwFix, teams) {
  const teamObj = teams.find(t => t.id === player.team);
  const teamShort = teamObj ? teamObj.short_name : '???';
  const teamCode = teamObj ? teamObj.code : 0;
  const posClass = {1:'gk',2:'def',3:'mid',4:'fwd'}[player.element_type] || 'mid';

  const cached = logoCache[teamCode];
  const inner = cached
    ? `<img src="${cached}" crossorigin="anonymous" alt="${esc(teamShort)}" loading="lazy">`
    : `<span class="fallback-text">${esc(teamShort)}</span>`;
  const badgeCls = cached ? '' : posClass;

  // Fixture
  let fixHtml = '';
  const pf = gwFix.filter(f => f.team_h === player.team || f.team_a === player.team);
  pf.forEach(f => {
    const home = f.team_h === player.team;
    const opp = teams.find(t => t.id === (home ? f.team_a : f.team_h));
    const name = opp ? opp.short_name : '???';
    const diff = home ? f.team_h_difficulty : f.team_a_difficulty;
    const loc = home ? '(H)' : '(a)';
    const cls = diff <= 2 ? 'fix-easy' : diff >= 4 ? 'fix-hard' : 'fix-mid';
    fixHtml += `<span class="${cls}">${name}${loc}</span> `;
  });
  if (!fixHtml) fixHtml = '<span class="fix-none">‚Äî</span>';

  // Captain/VC
  let badge = '';
  if (pick.is_captain) badge = '<div class="captain-badge">C</div>';
  else if (pick.is_vice_captain) badge = '<div class="vice-badge">V</div>';

  // Status dot (injury/doubt/suspended)
  let statusDot = '';
  if (player.status === 'i') statusDot = '<div class="status-dot injured" title="Injured"></div>';
  else if (player.status === 'd') statusDot = '<div class="status-dot doubt" title="Doubtful"></div>';
  else if (player.status === 's') statusDot = '<div class="status-dot suspended" title="Suspended"></div>';

  // News tooltip
  const newsAttr = player.news ? ` data-news="${esc(player.news)}"` : '';

  // Form dot (green >= 6, amber 3-6, red < 3)
  const form = parseFloat(player.form) || 0;
  let formDot = '';
  if (!statusDot) { // don't overlap with injury dot
    const formCls = form >= 6 ? 'hot' : form >= 3 ? 'warm' : 'cold';
    formDot = `<div class="form-dot ${formCls}" title="Form: ${form.toFixed(1)}"></div>`;
  }

  // Ownership badge
  const tsb = parseFloat(player.selected_by_percent) || 0;
  let ownBadge = '';
  if (tsb < 10) ownBadge = `<div class="own-badge diff" title="${tsb}% owned">DIFF</div>`;
  else if (tsb > 50) ownBadge = `<div class="own-badge ess" title="${tsb}% owned">ESS</div>`;

  // Form vs PPG indicator
  const ppg = parseFloat(player.points_per_game) || 0;
  let formInd = '';
  if (ppg > 0) {
    const delta = form - ppg;
    if (delta >= 1) formInd = `<div class="form-indicator rising" title="Form ${form.toFixed(1)} vs PPG ${ppg.toFixed(1)}">‚ñ≤ In-form</div>`;
    else if (delta <= -1) formInd = `<div class="form-indicator falling" title="Form ${form.toFixed(1)} vs PPG ${ppg.toFixed(1)}">‚ñº Off-form</div>`;
  }

  return `<div class="player-card"${newsAttr}>
    ${badge}
    <div class="player-badge ${badgeCls}">${inner}${statusDot || formDot}</div>
    <div class="player-name" title="${esc(player.web_name)}">${esc(player.web_name)}</div>
    ${ownBadge}
    ${formInd}
    <div class="player-fixture">${fixHtml}</div>
  </div>`;
}

// ---- Generate shareable image via Canvas ----
async function generateShareImage() {
  const m = managerData;
  const picks = picksData.picks || [];
  const players = bootstrapData.elements;
  const teams = bootstrapData.teams;
  const fixtures = bootstrapData._fixtures || [];

  const gwCount = Math.min(nextGWs.length, 5);
  const topRowCount = Math.min(gwCount, 3);
  const botRowCount = gwCount - topRowCount;
  const W = 1200;
  const colH = 430;
  const headerH = 120;
  const rowGap = 20;
  const footerH = 50;
  const H = botRowCount > 0 ? headerH + colH + rowGap + colH + footerH : headerH + colH + footerH;

  const scale = Math.min(window.devicePixelRatio || 1, 3);
  const canvas = document.createElement('canvas');
  canvas.width = W * scale; canvas.height = H * scale;
  canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
  const ctx = canvas.getContext('2d');
  ctx.scale(scale, scale);

  // Pre-load team badge images for canvas drawing
  const badgeImages = {};
  const usedTeamIds = new Set();
  picks.forEach(pick => {
    const pl = players.find(p => p.id === pick.element);
    if (pl) usedTeamIds.add(pl.team);
  });
  const gwIds = nextGWs.slice(0, 5).map(gw => gw.id);
  fixtures.filter(f => gwIds.includes(f.event)).forEach(f => {
    usedTeamIds.add(f.team_h);
    usedTeamIds.add(f.team_a);
  });
  // Reuse badge images already loaded in the DOM (with crossorigin="anonymous")
  document.querySelectorAll('.player-badge img[crossorigin]').forEach(img => {
    if (!img.complete || !img.naturalWidth) return;
    // Find the team ID from the src URL
    const match = img.src.match(/\/t(\d+)\.png/);
    if (!match) return;
    const code = Number(match[1]);
    const teamObj = teams.find(t => t.code === code);
    if (teamObj && usedTeamIds.has(teamObj.id)) {
      badgeImages[teamObj.id] = img;
    }
  });

  let useBadges = Object.keys(badgeImages).length > 0;

  const posMap = {1:'GKP',2:'DEF',3:'MID',4:'FWD'};
  const posOrder = ['GKP','DEF','MID','FWD'];
  const posColors = {GKP:'#f59e0b',DEF:'#3b82f6',MID:'#22c55e',FWD:'#ef4444'};
  const cellW = 46;

  function drawAll() {
    // Background
    ctx.fillStyle = '#0a0e17';
    ctx.fillRect(0, 0, W, H);

    // Header gradient bar
    const grad = ctx.createLinearGradient(0, 0, W, 0);
    grad.addColorStop(0, '#11998e');
    grad.addColorStop(1, '#38ef7d');
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, W, 4);

    // Title
    ctx.fillStyle = '#38ef7d';
    ctx.font = '600 14px DM Sans, sans-serif';
    ctx.textAlign = 'start';
    ctx.fillText('‚öΩ FPL VIEWER', 40, 40);
    ctx.fillStyle = '#ffffff';
    ctx.font = '700 24px DM Sans, sans-serif';
    ctx.fillText(`${m.player_first_name} ${m.player_last_name}`, 40, 72);
    ctx.fillStyle = '#94a3b8';
    ctx.font = '500 16px DM Sans, sans-serif';
    ctx.fillText(`${m.name}  ‚Ä¢  ${m.summary_overall_points} pts  ‚Ä¢  Rank ${(m.summary_overall_rank||0).toLocaleString()}`, 40, 96);

    // Expected points in header (right-aligned)
    const imgStats = getSquadStats();
    ctx.fillStyle = '#a78bfa';
    ctx.font = '700 18px DM Sans, sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText(`EP: ${imgStats.startersEP.toFixed(1)}`, W - 40, 72);
    ctx.fillStyle = '#64748b';
    ctx.font = '500 11px DM Sans, sans-serif';
    ctx.fillText('Expected Points (Starting XI)', W - 40, 90);
    ctx.textAlign = 'start';

    // Draw a single player cell
    function drawPlayer(item, px, py, pos) {
      const teamObj = teams.find(t => t.id === item.player.team);
      // Badge or fallback
      if (useBadges && badgeImages[item.player.team]) {
        ctx.drawImage(badgeImages[item.player.team], px + 11, py - 2, 22, 22);
      } else {
        ctx.fillStyle = posColors[pos];
        ctx.beginPath();
        ctx.arc(px + 22, py + 8, 10, 0, Math.PI * 2);
        ctx.fill();
        if (teamObj) {
          ctx.fillStyle = '#ffffff';
          ctx.font = '700 7px DM Sans, sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(teamObj.short_name, px + 22, py + 11);
        }
      }
      // Captain / vice-captain indicator
      if (item.pick.is_captain) {
        ctx.fillStyle = '#fbbf24';
        ctx.beginPath();
        ctx.arc(px + 33, py - 2, 5, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#0a0e17';
        ctx.font = '700 6px DM Sans, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('C', px + 33, py);
      } else if (item.pick.is_vice_captain) {
        ctx.fillStyle = '#94a3b8';
        ctx.beginPath();
        ctx.arc(px + 33, py - 2, 5, 0, Math.PI * 2);
        ctx.fill();
        ctx.fillStyle = '#0a0e17';
        ctx.font = '700 6px DM Sans, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('V', px + 33, py);
      }
      // Form dot (bottom-left of badge) ‚Äî skip if injured/doubtful/suspended
      const plStatus = item.player.status;
      const plForm = parseFloat(item.player.form) || 0;
      if (plStatus !== 'i' && plStatus !== 'd' && plStatus !== 's') {
        const dotColor = plForm >= 6 ? '#4ade80' : plForm >= 3 ? '#fbbf24' : '#f87171';
        ctx.fillStyle = dotColor;
        ctx.beginPath();
        ctx.arc(px + 12, py + 17, 4, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = '#111827';
        ctx.lineWidth = 1.5;
        ctx.stroke();
      }

      // Name
      ctx.fillStyle = '#ffffff';
      ctx.font = '600 8px DM Sans, sans-serif';
      ctx.textAlign = 'center';
      const displayName = item.player.web_name.length > 8 ? item.player.web_name.substring(0,7)+'‚Ä¶' : item.player.web_name;
      ctx.fillText(displayName, px + 22, py + 28);

      // Ownership badge (DIFF / ESS)
      const plTsb = parseFloat(item.player.selected_by_percent) || 0;
      if (plTsb < 10) {
        // Purple DIFF badge
        ctx.fillStyle = '#8b5cf640';
        ctx.beginPath();
        ctx.roundRect(px + 8, py + 30, 26, 9, 2);
        ctx.fill();
        ctx.fillStyle = '#a78bfa';
        ctx.font = '700 6px DM Sans, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('DIFF', px + 21, py + 37);
      } else if (plTsb > 50) {
        // Green ESS badge
        ctx.fillStyle = '#38ef7d25';
        ctx.beginPath();
        ctx.roundRect(px + 10, py + 30, 22, 9, 2);
        ctx.fill();
        ctx.fillStyle = '#4ade80';
        ctx.font = '700 6px DM Sans, sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('ESS', px + 21, py + 37);
      }

      // Form vs PPG indicator (In-form / Off-form)
      const plPpg = parseFloat(item.player.points_per_game) || 0;
      if (plPpg > 0) {
        const delta = plForm - plPpg;
        if (delta >= 1) {
          ctx.fillStyle = '#4ade80';
          ctx.font = '700 6px DM Sans, sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('\u25B2 In-form', px + 22, py + 44);
        } else if (delta <= -1) {
          ctx.fillStyle = '#f87171';
          ctx.font = '700 6px DM Sans, sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText('\u25BC Off-form', px + 22, py + 44);
        }
      }
    }

    // Draw a single GW column
    function drawGWColumn(gw, x, y, cW) {
      const gwFix = fixtures.filter(f => f.event === gw.id);

      // Column bg
      ctx.fillStyle = '#111827';
      ctx.beginPath();
      ctx.roundRect(x, y, cW, colH, 8);
      ctx.fill();

      // GW header
      const gwDl = gw.deadline_time ? new Date(gw.deadline_time) : null;
      const gwDlStr = gwDl ? gwDl.toLocaleDateString('en-GB',{day:'numeric',month:'short'}) : '';
      ctx.fillStyle = '#1a2332';
      ctx.beginPath();
      ctx.roundRect(x, y, cW, 36, [8, 8, 0, 0]);
      ctx.fill();
      ctx.fillStyle = '#ffffff';
      ctx.font = '700 14px DM Sans, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText(`GW${gw.id}`, x + cW/2, y + (gwDlStr ? 19 : 24));
      if (gwDlStr) {
        ctx.fillStyle = '#64748b';
        ctx.font = '500 9px DM Sans, sans-serif';
        ctx.fillText(gwDlStr, x + cW/2, y + 31);
      }

      const starters = picks.filter(p => p.position <= 11);
      const bench = picks.filter(p => p.position > 11);

      // Group starters by position
      function groupByPos(list) {
        const g = {};
        posOrder.forEach(p => g[p] = []);
        list.forEach(pick => {
          const pl = players.find(p => p.id === pick.element);
          if (pl) g[posMap[pl.element_type]||'MID'].push({pick,player:pl});
        });
        return g;
      }

      // Draw fixture text below a player
      function drawFixture(item, px, py) {
        const pf = gwFix.filter(f => f.team_h === item.player.team || f.team_a === item.player.team);
        if (pf.length) {
          const f = pf[0];
          const home = f.team_h === item.player.team;
          const opp = teams.find(t => t.id === (home ? f.team_a : f.team_h));
          const diff = home ? f.team_h_difficulty : f.team_a_difficulty;
          ctx.fillStyle = diff <= 2 ? '#4ade80' : diff >= 4 ? '#f87171' : '#fbbf24';
          ctx.font = '500 7px DM Sans, sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(`${opp?.short_name||'???'}${home?'(H)':'(a)'}`, px + 22, py + 51);
        }
      }

      // Starters
      let py = y + 48;
      const starterGroups = groupByPos(starters);
      posOrder.forEach(pos => {
        const group = starterGroups[pos];
        if (group.length === 0) return;
        const rowW = group.length * cellW;
        const rowX = x + (cW - rowW) / 2;
        group.forEach((item, pi) => {
          const ppx = rowX + pi * cellW;
          drawPlayer(item, ppx, py, pos);
          drawFixture(item, ppx, py);
        });
        py += 58;
      });

      // Bench separator
      py += 2;
      ctx.strokeStyle = '#334155';
      ctx.lineWidth = 1;
      ctx.setLineDash([4, 3]);
      ctx.beginPath();
      ctx.moveTo(x + 15, py);
      ctx.lineTo(x + cW - 15, py);
      ctx.stroke();
      ctx.setLineDash([]);
      py += 8;

      // Bench label
      ctx.fillStyle = '#64748b';
      ctx.font = '500 8px DM Sans, sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('BENCH', x + cW/2, py + 4);
      py += 12;

      // Bench players in a single row
      const benchRowW = bench.length * cellW;
      const benchRowX = x + (cW - benchRowW) / 2;
      bench.forEach((pick, i) => {
        const pl = players.find(p => p.id === pick.element);
        if (pl) {
          const pos = posMap[pl.element_type] || 'MID';
          const ppx = benchRowX + i * cellW;
          drawPlayer({pick, player: pl}, ppx, py, pos);
          drawFixture({pick, player: pl}, ppx, py);
        }
      });
    }

    // Layout: top row
    const margin = 40;
    const colGap = 12;
    const topColW = (W - 2 * margin - (topRowCount - 1) * colGap) / topRowCount;
    const startY = headerH;

    nextGWs.slice(0, topRowCount).forEach((gw, i) => {
      drawGWColumn(gw, margin + i * (topColW + colGap), startY, topColW);
    });

    // Layout: bottom row (centered)
    if (botRowCount > 0) {
      const botColW = topColW;
      const botTotalW = botRowCount * botColW + (botRowCount - 1) * colGap;
      const botStartX = (W - botTotalW) / 2;
      const botStartY = startY + colH + rowGap;
      nextGWs.slice(topRowCount, topRowCount + botRowCount).forEach((gw, i) => {
        drawGWColumn(gw, botStartX + i * (botColW + colGap), botStartY, botColW);
      });
    }

    // Watermark
    ctx.fillStyle = '#64748b';
    ctx.font = '500 12px DM Sans, sans-serif';
    ctx.textAlign = 'right';
    ctx.fillText(window.location.origin + '?id=' + managerData.id, W - 40, H - 16);
    ctx.textAlign = 'start';
  }

  // Draw everything
  drawAll();

  // Download / share
  canvas.toBlob(blob => {
    const url = URL.createObjectURL(blob);
    // Try native share with image on mobile
    if (navigator.canShare && navigator.canShare({ files: [new File([blob], 'fpl-team.png', {type:'image/png'})] })) {
      navigator.share({
        title: `${m.player_first_name}'s FPL Team`,
        files: [new File([blob], 'fpl-team.png', {type:'image/png'})],
      });
    } else {
      const a = document.createElement('a');
      a.href = url;
      a.download = `fpl-team-${managerData.id}.png`;
      a.click();
      showToast('Image downloaded!');
    }
  }, 'image/png');
}

// ---- Helpers ----
function esc(s){return String(s||'').replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[c])}
function showLoading(){document.getElementById('content').innerHTML=`<div class="loading"><div class="spinner"></div><p>Loading your team‚Ä¶</p></div>`}
function showError(msg){document.getElementById('content').innerHTML=`<div class="error-msg">${esc(msg)}</div>`}
function shareLink(){
  const url=window.location.href;
  if(navigator.share) navigator.share({title:'My FPL Team',url});
  else navigator.clipboard.writeText(url).then(()=>showToast('Link copied!')).catch(()=>{});
}
function showToast(msg){
  const t=document.getElementById('toast');t.textContent=msg;
  t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2400);
}
</script>
</body>
</html>
